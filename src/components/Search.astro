---
// Search Modal Component with Pagefind integration
---

<div
  id="search-modal"
  class="fixed inset-0 z-[100] hidden items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-title"
  style="display: none !important; visibility: hidden !important; opacity: 0 !important;"
>
  <!-- Backdrop -->
  <div
    id="search-backdrop"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
    aria-hidden="true"
    style="display: none;"
  ></div>

  <!-- Modal Container -->
  <div
    class="relative z-[101] w-full max-w-2xl rounded-xl border border-gray-700 bg-gray-900 shadow-2xl"
  >
    <!-- Search Input Container -->
    <div class="flex items-center gap-3 border-b border-gray-700 px-4 py-3">
      <svg
        class="h-5 w-5 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>
      <input
        id="search-input"
        type="text"
        placeholder="Search posts..."
        class="flex-1 bg-transparent text-lg text-white placeholder-gray-400 outline-none"
        autocomplete="off"
        aria-label="Search posts"
      />
      <!-- Keyboard shortcut hint -->
      <kbd class="hidden rounded border border-gray-600 bg-gray-800 px-2 py-1 text-xs text-gray-400 sm:inline-flex">
        <span class="sr-only">Press </span>Esc
        <span class="sr-only"> to close</span>
      </kbd>
    </div>

    <!-- Results Container -->
    <div
      id="search-results"
      class="max-h-[60vh] overflow-y-auto px-4 py-3"
      role="listbox"
      aria-label="Search results"
    >
      <!-- Empty state -->
      <div id="search-empty" class="py-8 text-center text-gray-400">
        <p class="text-sm">Type to search...</p>
      </div>

      <!-- Loading state -->
      <div id="search-loading" class="hidden py-8 text-center text-gray-400">
        <p>Searching...</p>
      </div>

      <!-- No results state -->
      <div id="search-no-results" class="hidden py-8 text-center text-gray-400">
        <p>No results found</p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    function init() {
      // State management
      let isOpen = false;
      let pagefind: any = null;
      let searchIndex: any = null;
      let currentResults: any[] = [];
      let selectedIndex = -1;
      let pagefindLoading = false;

      // DOM elements
      const modal = document.getElementById('search-modal') as HTMLElement;
      const backdrop = document.getElementById('search-backdrop') as HTMLElement;
      const input = document.getElementById('search-input') as HTMLInputElement;
      const resultsContainer = document.getElementById('search-results') as HTMLElement;
      const emptyState = document.getElementById('search-empty') as HTMLElement;
      const loadingState = document.getElementById('search-loading') as HTMLElement;
      const noResultsState = document.getElementById('search-no-results') as HTMLElement;

      if (!modal || !backdrop || !input || !resultsContainer) {
        console.error('Search modal elements not found');
        return;
      }

      // Force modal to be hidden on initialization - use !important via setProperty
      modal.style.setProperty('display', 'none', 'important');
      modal.style.setProperty('visibility', 'hidden', 'important');
      modal.style.setProperty('opacity', '0', 'important');
      modal.style.setProperty('pointer-events', 'none', 'important');
      backdrop.style.setProperty('display', 'none', 'important');
      backdrop.style.setProperty('visibility', 'hidden', 'important');
      backdrop.style.setProperty('opacity', '0', 'important');
      backdrop.style.setProperty('pointer-events', 'none', 'important');
      modal.classList.add('hidden');
      modal.classList.remove('flex');

      // Ensure isOpen state is false
      isOpen = false;

      // Initialize Pagefind (lazy load)
      async function initPagefind() {
        if (pagefind) return;
        if (pagefindLoading) return;

        pagefindLoading = true;

        try {
          // Check if Pagefind files exist (they're only generated after build)
          const pagefindUrl = '/pagefind/pagefind.js';
          let pagefindAvailable = false;

          try {
            const checkResponse = await fetch(pagefindUrl, { method: 'HEAD' });
            pagefindAvailable = checkResponse.ok;
          } catch (checkError) {
            pagefindAvailable = false;
          }

          if (!pagefindAvailable) {
            pagefindLoading = false;
            showError('Search index not available. Please build the site first (npm run build).');
            return;
          }

          // Dynamically import using Function constructor to prevent Vite static analysis
          // This prevents Vite from trying to resolve the import at build time
          const importPagefind = new Function('url', 'return import(url)');
          const pagefindModule = await importPagefind(pagefindUrl);

          pagefind = pagefindModule;
          searchIndex = await pagefind.search('');
          pagefindLoading = false;
        } catch (error) {
          pagefindLoading = false;
          console.error('Failed to load Pagefind:', error);
          showError('Search is temporarily unavailable. Please build the site first (npm run build).');
        }
      }

      // Open modal
      function openModal() {
        if (isOpen) return;
        isOpen = true;
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.setProperty('visibility', 'visible', 'important');
        modal.style.setProperty('opacity', '1', 'important');
        modal.style.setProperty('pointer-events', 'auto', 'important');
        backdrop.style.setProperty('display', 'block', 'important');
        backdrop.style.setProperty('visibility', 'visible', 'important');
        backdrop.style.setProperty('opacity', '1', 'important');
        backdrop.style.setProperty('pointer-events', 'auto', 'important');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        input.focus();

        // Initialize Pagefind when modal opens
        initPagefind();
      }

      // Close modal
      function closeModal() {
        if (!isOpen) return;
        isOpen = false;
        modal.style.setProperty('display', 'none', 'important');
        modal.style.setProperty('visibility', 'hidden', 'important');
        modal.style.setProperty('opacity', '0', 'important');
        modal.style.setProperty('pointer-events', 'none', 'important');
        backdrop.style.setProperty('display', 'none', 'important');
        backdrop.style.setProperty('visibility', 'hidden', 'important');
        backdrop.style.setProperty('opacity', '0', 'important');
        backdrop.style.setProperty('pointer-events', 'none', 'important');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
        input.value = '';
        selectedIndex = -1;
        clearResults();
      }

      // Clear results
      function clearResults() {
      resultsContainer.innerHTML = '';
      emptyState.classList.remove('hidden');
      loadingState.classList.add('hidden');
        noResultsState.classList.add('hidden');
      }

      // Show error
      function showError(message: string) {
      resultsContainer.innerHTML = `
        <div class="py-8 text-center text-red-400">
          <p>${message}</p>
        </div>
      `;
      }

      // Render search results
      function renderResults(results: any[], query: string) {
      if (results.length === 0) {
        emptyState.classList.add('hidden');
        loadingState.classList.add('hidden');
        noResultsState.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        return;
      }

      emptyState.classList.add('hidden');
      loadingState.classList.add('hidden');
      noResultsState.classList.add('hidden');

      const resultsHTML = results
        .map((result, index) => {
          const url = result.url;
          const title = result.meta?.title || 'Untitled';
          const excerpt = result.excerpt || '';

          // Highlight search terms in title and excerpt
          const highlightRegex = new RegExp(`(${query})`, 'gi');
          const highlightedTitle = title.replace(highlightRegex, '<mark class="bg-orange-500/30 text-orange-300">$1</mark>');
          const highlightedExcerpt = excerpt.replace(highlightRegex, '<mark class="bg-orange-500/30 text-orange-300">$1</mark>');

          return `
            <a
              href="${url}"
              class="search-result block rounded-lg border border-transparent px-4 py-3 transition-colors ${
                index === selectedIndex
                  ? 'border-orange-500 bg-orange-500/10'
                  : 'hover:border-gray-700 hover:bg-gray-800'
              }"
              data-index="${index}"
            >
              <h3 class="mb-1 text-base font-semibold text-white">${highlightedTitle}</h3>
              ${excerpt ? `<p class="text-sm text-gray-400 line-clamp-2">${highlightedExcerpt}</p>` : ''}
            </a>
          `;
        })
        .join('');

      resultsContainer.innerHTML = resultsHTML;

      // Add click handlers
      const resultLinks = resultsContainer.querySelectorAll('.search-result');
      resultLinks.forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = (link as HTMLAnchorElement).href;
          window.location.href = href;
          closeModal();
        });
      });
      }

      // Perform search
      async function performSearch(query: string) {
      if (!query.trim()) {
        clearResults();
        return;
      }

      if (!searchIndex) {
        loadingState.classList.remove('hidden');
        emptyState.classList.add('hidden');
        noResultsState.classList.add('hidden');
        return;
      }

      loadingState.classList.remove('hidden');
      emptyState.classList.add('hidden');
      noResultsState.classList.add('hidden');

      try {
        const search = await searchIndex.search(query);
        const results = await Promise.all(
          search.results.slice(0, 8).map(async (result: any) => {
            const data = await result.data();
            return {
              url: result.url,
              meta: data.meta,
              excerpt: data.excerpt,
            };
          })
        );

        currentResults = results;
        selectedIndex = -1;
        renderResults(results, query);
      } catch (error) {
        console.error('Search error:', error);
        showError('An error occurred while searching');
      }
      }

      // Keyboard navigation
      function handleKeyDown(e: KeyboardEvent) {
      if (!isOpen) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection();
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const selectedResult = currentResults[selectedIndex];
        if (selectedResult) {
          window.location.href = selectedResult.url;
          closeModal();
        }
      }
      }

      function updateSelection() {
      const resultLinks = resultsContainer.querySelectorAll('.search-result');
      resultLinks.forEach((link, index) => {
        if (index === selectedIndex) {
          link.classList.add('border-orange-500', 'bg-orange-500/10');
          link.classList.remove('hover:border-gray-700', 'hover:bg-gray-800');
          link.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          link.classList.remove('border-orange-500', 'bg-orange-500/10');
          link.classList.add('hover:border-gray-700', 'hover:bg-gray-800');
        }
      });
      }

      // Event listeners
      input.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value;
        performSearch(query);
      });

      // Close on backdrop click
      backdrop.addEventListener('click', closeModal);

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        // Prevent default for Cmd/Ctrl+K to avoid conflicts
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          e.stopPropagation();
          if (isOpen) {
            closeModal();
          } else {
            openModal();
          }
          return;
        }

        if (e.key === 'Escape' && isOpen) {
          e.preventDefault();
          e.stopPropagation();
          closeModal();
          return;
        }

        if (isOpen) {
          handleKeyDown(e);
        }
      }, true); // Use capture phase to catch early

      // Listen for custom event from search button
      window.addEventListener('openSearch', () => {
        openModal();
      });

      // Prevent body scroll when modal is open
      modal.addEventListener('transitionend', () => {
        if (!isOpen) {
          document.body.style.overflow = '';
        }
      });
    }
  })();
</script>

<style>
  /* Custom scrollbar for results */
  #search-results::-webkit-scrollbar {
    width: 8px;
  }

  #search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  #search-results::-webkit-scrollbar-thumb {
    background: #3a3a3a;
    border-radius: 4px;
  }

  #search-results::-webkit-scrollbar-thumb:hover {
    background: #4a4a4a;
  }

  /* Ensure modal is completely hidden by default - highest priority */
  #search-modal {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    position: fixed !important;
    top: -9999px !important;
    left: -9999px !important;
    right: auto !important;
    bottom: auto !important;
    pointer-events: none !important;
    z-index: -9999 !important;
    width: 0 !important;
    height: 0 !important;
    max-width: 0 !important;
    max-height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Hide all children when modal is closed */
  #search-modal:not(.flex) > *,
  #search-modal:not(.flex) * {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    width: 0 !important;
    height: 0 !important;
    max-width: 0 !important;
    max-height: 0 !important;
    overflow: hidden !important;
    position: absolute !important;
    top: -9999px !important;
    left: -9999px !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Show modal when it has the flex class */
  #search-modal.flex {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    animation: fadeIn 0.2s ease-out;
    pointer-events: auto !important;
    z-index: 100 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    max-width: 100% !important;
    max-height: 100% !important;
    overflow: visible !important;
    margin: 0 !important;
    padding: 1rem !important;
  }

  /* Show children when modal is open */
  #search-modal.flex > * {
    display: revert !important;
    visibility: visible !important;
    opacity: revert !important;
    pointer-events: revert !important;
    width: revert !important;
    height: revert !important;
    overflow: revert !important;
  }

  /* Ensure backdrop is completely hidden when modal is hidden */
  #search-backdrop {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    position: fixed !important;
    top: -9999px !important;
    left: -9999px !important;
    width: 0 !important;
    height: 0 !important;
    max-width: 0 !important;
    max-height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Show backdrop when modal is open */
  #search-modal.flex #search-backdrop {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: auto !important;
    width: 100% !important;
    height: 100% !important;
  }

  /* Mobile-specific: ensure modal is hidden */
  @media (max-width: 768px) {
    #search-modal:not(.flex) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      position: fixed !important;
      top: -9999px !important;
      left: -9999px !important;
      width: 0 !important;
      height: 0 !important;
      max-width: 0 !important;
      max-height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    #search-modal:not(.flex) *,
    #search-modal:not(.flex) > * {
      display: none !important;
      visibility: hidden !important;
      position: absolute !important;
      top: -9999px !important;
      left: -9999px !important;
      width: 0 !important;
      height: 0 !important;
    }

    #search-backdrop:not(.flex ~ *) {
      display: none !important;
      visibility: hidden !important;
      position: fixed !important;
      top: -9999px !important;
      left: -9999px !important;
      width: 0 !important;
      height: 0 !important;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Focus styles */
  #search-input:focus {
    outline: none;
    ring: 0;
  }
</style>

