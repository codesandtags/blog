---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Sidebar from '@/components/Sidebar.astro';
import { getCollection } from 'astro:content';
import { SITE } from '@/consts';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tagsSet = new Set<string>();

  posts.forEach((post) => {
    post.data.tags.forEach((tag) => {
      // Normalize tag name to slug
      const slug = tag.toLowerCase().replace(/\s+/g, '-');
      tagsSet.add(slug);
    });
  });

  return Array.from(tagsSet).map((slug) => {
    // Find posts for this tag
    const tagPosts = posts
      .filter((post) =>
        post.data.tags.some((tag) =>
          tag.toLowerCase().replace(/\s+/g, '-') === slug
        )
      )
      .filter((post) => !post.data.draft)
      .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

    // Get the original tag name from the first post
    const tagName = tagPosts[0]?.data.tags.find((tag) =>
      tag.toLowerCase().replace(/\s+/g, '-') === slug
    ) || slug;

    return {
      params: { slug },
      props: {
        tagName,
        posts: tagPosts,
      },
    };
  });
}

interface Props {
  tagName: string;
  posts: Awaited<ReturnType<typeof getCollection>>;
}

const { tagName, posts } = Astro.props;
---

<BaseLayout
  title={`#${tagName} - Tags`}
  description={`Posts tagged with ${tagName} on ${SITE.title}`}
>
  <div class="layout-container">
    <Sidebar />

    <main class="main-content">
      <header class="page-header">
        <h1 class="page-title">Tag: #{tagName}</h1>
        <p class="page-description">
          {posts.length} {posts.length === 1 ? 'post' : 'posts'} with this tag
        </p>
      </header>

      <div class="posts-list">
        {posts.map((post) => (
          <article class="post-card">
            <time class="post-date" datetime={post.data.date.toISOString()}>
              {new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              }).format(post.data.date)}
            </time>
            <h2 class="post-card-title">
              <a href={`/posts/${post.slug}/`}>{post.data.title}</a>
            </h2>
            {post.data.categories.length > 0 && (
              <div class="post-card-categories">
                {post.data.categories.map((category) => (
                  <a
                    href={`/categories/${category.toLowerCase().replace(/\s+/g, '-')}/`}
                    class="category-badge"
                  >
                    {category}
                  </a>
                ))}
              </div>
            )}
          </article>
        ))}
      </div>

      {posts.length === 0 && (
        <div class="empty-state">
          <p>No posts found with this tag.</p>
        </div>
      )}
    </main>
  </div>
</BaseLayout>

<style>
  .layout-container {
    display: flex;
    min-height: 100vh;
  }

  .main-content {
    flex: 1;
    max-width: var(--content-max-width);
    width: 100%;
    padding: 3rem 2rem;
    margin-left: var(--sidebar-width);
    margin-right: auto;
  }

  .page-header {
    margin-bottom: 3rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--color-border);
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 0.5rem;
  }

  .page-description {
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .post-card {
    padding: 2rem;
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    transition: all 0.2s;
  }

  .post-card:hover {
    border-color: var(--color-link);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .post-date {
    display: block;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
  }

  .post-card-title {
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .post-card-title a {
    color: var(--color-text);
    text-decoration: none;
  }

  .post-card-title a:hover {
    color: var(--color-link);
    text-decoration: underline;
  }

  .post-card-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 0.85rem;
    color: var(--color-text);
    text-decoration: none;
  }

  .category-badge:hover {
    background-color: var(--color-link);
    color: var(--color-text-on-accent);
    border-color: var(--color-link);
  }

  .empty-state {
    padding: 3rem;
    text-align: center;
    color: var(--color-text-muted);
  }

  @media (max-width: 1024px) {
    .main-content {
      margin-left: 0;
      padding: 2rem 1rem;
    }

    .page-title {
      font-size: 2rem;
    }

    .post-card {
      padding: 1.5rem;
    }
  }
</style>

